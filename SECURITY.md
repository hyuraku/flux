# flux セキュリティ設計書

## 概要

fluxはP2Pファイル転送アプリであり、以下のセキュリティ目標を達成するよう設計されています：

1. **機密性**: 転送データはE2E暗号化され、第三者に読み取られない
2. **完全性**: 転送データの改ざんを検出できる
3. **可用性**: コード推測攻撃による妨害を防止

---

## 脅威モデル

### 想定する攻撃者

| 攻撃者タイプ | 能力 | 例 |
|-------------|------|-----|
| 受動的攻撃者 | ネットワーク盗聴 | 公衆Wi-Fi運営者 |
| 能動的攻撃者 | メッセージ改ざん、注入 | MITM攻撃者 |
| 内部攻撃者 | サーバーアクセス | 悪意あるサーバー管理者 |

### 想定しない攻撃

- エンドポイント（ブラウザ）への直接攻撃
- 物理的なデバイスへのアクセス
- ブラウザの脆弱性を利用した攻撃

---

## セキュリティ対策

### 1. E2E暗号化

**実装**: `src/client/core/transfer/EncryptionService.ts`

| 項目 | 仕様 |
|------|------|
| 鍵交換 | ECDH (P-256 / secp256r1) |
| 暗号化 | AES-GCM 256bit |
| IV | 96bit、暗号化ごとにランダム生成 |
| 認証タグ | 128bit（AES-GCMデフォルト） |

**鍵ライフサイクル**:
1. セッション開始時に鍵ペア生成
2. 公開鍵をシグナリングサーバー経由で交換
3. 共有鍵を導出（ECDH）
4. セッション終了時に鍵を破棄

**セキュリティ特性**:
- 前方秘匿性: 各セッションで新しい鍵ペアを生成
- 認証付き暗号化: AES-GCMにより改ざん検出

### 2. コード推測攻撃対策

**実装**: `src/party/CodeManager.ts`

| 対策 | 設定値 |
|------|--------|
| コード空間 | 10,000通り（0000-9999） |
| レート制限 | 10回/分/IP |
| ロックアウト | 3回失敗で5分間ブロック |
| コード有効期限 | 10分 |

**攻撃成功確率**:
- レート制限下: 10回/分 × 10分 = 最大100回試行
- 成功確率: 100 / 10,000 = 1%

### 3. 入力バリデーション

**実装**: `src/client/utils/validators.ts`

| 入力 | バリデーション |
|------|---------------|
| コード | 4桁数字のみ、サニタイズ |
| ファイル名 | パストラバーサル対策、予約語除去 |
| ファイルサイズ | 最大2GB |
| WebSocket URL | プロトコル検証 |

### 4. XSS対策

- `escapeHtml()`: ユーザー入力のHTMLエスケープ
- `sanitizeFileName()`: ファイル名のサニタイズ
- React: デフォルトでエスケープ

### 5. CSP (Content Security Policy)

**推奨設定**（`_headers` または `vercel.json`）:

```
Content-Security-Policy:
  default-src 'self';
  script-src 'self' 'unsafe-inline';
  style-src 'self' 'unsafe-inline';
  connect-src 'self' wss://party.flux.io;
  img-src 'self' data: blob:;
  worker-src 'self' blob:;
```

### 6. CORS設定

**PartyKit設定**:
```javascript
// 本番環境でのCORS設定例
origin: ['https://flux.io']
```

---

## 残存リスク

| リスク | 深刻度 | 緩和策 |
|--------|--------|--------|
| コード推測（低確率） | 中 | レート制限、有効期限 |
| シグナリングサーバー侵害 | 中 | E2E暗号化でデータは保護 |
| WebRTC ICE漏洩 | 低 | プライベートIPのみ露出 |
| ブラウザ脆弱性 | 低 | ユーザー側で最新ブラウザ使用を推奨 |

---

## セキュリティチェックリスト

- [x] E2E暗号化（AES-GCM 256bit）
- [x] 鍵交換（ECDH P-256）
- [x] 前方秘匿性（セッションごとの鍵生成）
- [x] レート制限（10回/分/IP）
- [x] ロックアウト（3回失敗で5分ブロック）
- [x] コード有効期限（10分）
- [x] 入力バリデーション
- [x] XSS対策
- [ ] CSP設定（デプロイ時に設定）
- [ ] CORS設定（デプロイ時に設定）
- [ ] HTTPS強制（デプロイ時に設定）

---

## セキュリティ連絡先

セキュリティに関する問題を発見した場合は、公開前に以下へ報告してください：

- Email: security@flux.io（仮）

---

## 更新履歴

| 日付 | 変更内容 |
|------|----------|
| 2026-02-06 | 初版作成 |
